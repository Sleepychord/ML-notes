# 拉格朗日乘数法
---

我们来考虑带约束的多元函数极值问题，拉格朗日乘数法
是解这类问题常用解法。
$$
min \ F(x), \ st. h(x)_i=0(i = 0,1,2...,m)
$$
其中x为n维向量，不妨假设这里的函数是“良好的”，足够光滑，有极值。更详细的信息可以看[维基百科](https://en.wikipedia.org/wiki/Karush–Kuhn–Tucker_conditions#Regularity_conditions_.28or_constraint_qualifications.29)的正则条件。
注意到一个非常重要的性质：
> 极值点处，目标函数梯度与限制函数的解空间垂直

反证：如果不垂直，那么在极值点附近、解空间内沿着梯度分量或其反方向走，必能使得函数值增大或减小。

更直观的解释见下图，红色是解空间，蓝色虚线是目标函数的等高线。在极值点处目标函数梯度方向与解空间垂直；可以想象如果是三维，那么解空间可能是一个平面的形式，此时极值点处梯度方法应该跟解平面法线平行。
![](/assets/359cdc26e15205e66204bce2b33e4535_b.jpg)
如果有多个限制函数，那么我们只能在解空间交集中取值，此时梯度方向只需与这个交集（也就是两个限制函数解空间的张成）垂直。（不妨想一下三维空间限制为两个平面交集的例子）
即$$
\nabla F = \lambda_1\nabla h_1 + \lambda_2\nabla h_2 + ... + \lambda_m\nabla h_m
$$
在极值点处成立。结合m各限制函数为零本身，可以得到n+m个n+m元方程。
如果我们记拉格朗日函数为$$
J(x,\lambda) = F(x) + \sum\limits_{i=1}^{m} \lambda_ih_i(x)
$$
这个n+m元方程组就可以写成$$ \left\{
\begin{aligned}
& \frac{\partial J}{x_i}= 0 &(i=1,...,n)\\
& \frac{\partial J}{\lambda_i}= 0& (i=1,...,m)
\end{aligned}
\right.
$$
至此我们将有限制的多元函数极值问题转化成了解非线性方程组的问题，当然这个问题仍然并非那么简单，但是很多问题中我们可以手动进行计算化简；如果足够光滑，解也比较唯一，我们可以使用**牛顿迭代法**解非线性方程组。
注意的是这些都是问题极小值的**必要条件**，这些方程可能有多解，它们可能是极大值或鞍点等。我们需要将解进行验证。
## 不等式限制条件
之前的问题中限制条件都是$$h(x)=0$$的形式，如果限制条件为不等式（都化成小于等于）应该如何处理？
我们不从凸优化的角度去看，而是接着刚才思路来。
$$
min \ F(x) \\
\ st. h(x)_i=0(i = 0,1,2...,m_1)\\
h(x)_j \leq 0(j = m_1+1,...,m_2)
$$

首先考虑如果我们将这些不等式当成等式（那么就跟上面一样）做会有什么问题？(当然上面的那个仍然是个必要条件，但是由于不等约束本身太弱，基本上有无穷多解，所以还要探索更强的条件)
假设我们的极值点就落在不等式代表的边界上，那其实没有什么差别。那如果极值点在不等式可行区域的内部呢？一个自然的想法是直接在拉格朗日函数中把对应的项去掉，然后只要求满足原不等式。
如果把两者合起来就可以得到$$\lambda_jh(x^*)_j = 0(j=m_1+1,...m_2)$$，当$$\lambda_j=0$$时，说明在不等式内部，这一项不起作用；当$$\lambda_j\neq0$$时，说明在不等式边界，此时必有$$h(x)_j =0$$。

其实仔细想还可以发现另一个更强的条件，我们的题目中要求的是目标函数的最小值，如果不等式约束取边界的时候，还有一个跟方向性相关的要求：
首先我们要发现
> $$h(x)\leq 0$$的梯度方向指向其不可行域

这个我们容易在二维三维上验证，比如$$x+y\leq 0$$的梯度方向(1,1)指向的就是不可行的半平面。
那么回到当时推导“极值点处梯度方法应该跟解平面法线平行”的时候，当时的解空间法方向正负两侧都不能取，所以只要求“平行”；现在对于不等式约束，有一侧是解空间可取的，所以我们不仅要求“平行”，还得要求目标函数下降最快的方向是不可取的那个方向，即$$\nabla F = \lambda_j\nabla h,(\lambda_j>=0)$$。
综合起来我们就得到被称为KKT条件的一组条件：
$$ \left\{
\begin{aligned}
& \frac{\partial J}{x_i}= 0 &(i=1,...,n)\\
& \frac{\partial J}{\lambda_i}= 0\ aka.\ h(x)_i=0 & (i=1,...,m_1)\ \\
& h(x)_j \leq 0 &(j=m_1+1,...,m_2)\\
&\lambda_jh(x^*)_j = 0&(j=m_1+1,...m_2)\\
&\lambda_j\geq 0&(j=m_1+1,...m_2)
\end{aligned}
\right.
$$
这组条件中有不等式约束，就很难使用牛顿迭代法求解了。但特殊的问题通常有更好的性质，例如凸问题等。如果想去掉这些不等式约束，不妨看一下我们下面讲的拉格朗日对偶的内容。
##拉格朗日对偶
考虑函数$$L(x)=\max\limits_{\lambda,\lambda_j(j=m_1+1,...m_2) \geq 0} J(x,\lambda)$$。
* 当x满足约束条件的时候，$$\sum\limits_{j=1}^{m_1}\lambda_jh_j(x) = 0, \sum\limits_{j=m_1+1}^{m_2}\lambda_jh_j(x) \leq 0。$$最大值在$$\lambda = 0$$的时候取得且$$L(x)=F(x)$$。
* 当x不满足约束条件的时候，假设不满足$$h_i(x)=0$$，我们只需让$$L(x)$$中系数$$\lambda_i\rightarrow \infty$$即可让$$J(x,\lambda)\rightarrow \infty$$。此时$$L(x)\rightarrow \infty$$。不满足不等式约束的情况同理。

于是我们可以对原问题做一个转化
$$
\min\limits_{x \ with \ st. \ 1-m_2} F(x) = \min\limits_x\max\limits_{\lambda,\lambda_j(j=m_1+1,...m_2) \geq 0} J(x,\lambda)
$$
这样就从形式上消除了各种限制条件。很多问题中它的对偶问题更加简单，考虑函数$$D(\lambda)=\min\limits_x J(x,\lambda)$$
这个函数与之前讨论的L有什么关系吗？我们来看一个简单的推导。（为了写起来简单，我们下面的$$\lambda$$限制中的$$\lambda_j(j=m_1+1,...m_2) \geq 0$$在写的时候省略，但是所有的$$\lambda$$都在满足这个限制的条件下取值。）
> $$(\forall x_0, \forall \lambda_0)D(\lambda_0) = \min\limits_x J(x,\lambda_0) \leq J(x_0, \lambda_0)\leq 
\max\limits_{\lambda}J(x_0,\lambda)= L(x_0)$$ 

这说明$$\max\limits_\lambda D(\lambda) \leq \min\limits_x L(x) = 原问题的解$$，这里的等号能不能取到也是一个值得讨论的事情，如果能，称问题具有**强对偶性**。此时可以通过求对偶问题$$\max\limits_\lambda D(\lambda)$$的解来解原问题，他们的极值点相同且满足KKT条件。

怎样的问题有强对偶性？这里有一个充分条件：如果满足开始提到的“正则条件”且原问题是凸的，那么有强对偶性。
对偶有什么用？诚然对于一般的问题转化成对偶问题未必更容易，但是对于很多问题例如SVM来说确实可以更简单（毕竟大多数不等式限制都消失了，维度由$$x$$的维度变成了$$\lambda$$的维度），总之是条化简的思路。